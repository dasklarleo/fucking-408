# CPU

## 基本结构和功能

### 结构

CPU可以分为运算器和控制器

运算器：

1. 算数逻辑单元：算数或者逻辑运算
2. 暂存寄存器：暂存从主存之中取出来的**数据**
3. 累加寄存器：暂存ALU运算的结果，或者作为ALU的一个输入
4. 通用寄存器组：AX、BX、SP等
5. 程序状态寄存器：NF（负号）、ZF（结果为0）、CF（加分有进位或者减法借位）、OF（溢出）、SF（和最高位一样）
6. 移位器：左右移动
7. 计数器：乘除运算需要进行的步数

控制器

1. 程序计数器：**PC，一般具有自增功能**
2. 指令寄存器：IR，保存正在执行的这一条指令
3. 指令译码器：对操作码进行译码
4. 存储器地址寄存器：MAR、存放向主存写入或者从主存读出的信息
5. 存储器数据寄存器：MDR、存放要向主存写入的数据
6. 时序系统：产生各种时序信号
7. 微操作信号发生器：根据IR、PSW产生各种操作信号

### 功能

1. 指令控制：完成取指令、分析指令、执行指令的操作
2. 操作控制：完成对指令需要的各个部件的操作
3. 时间控制：为每一条指令的执行提供应有的控制信号
4. 数据加工：算数和逻辑运算
5. 中断处理：处理异常和特殊情况

## 指令执行过程

### 指令周期

1. 指令周期：从内存之中取出并执行一条指令的时间，通常包含若干机器周期 
2. 机器周期：CPU执行的各个步骤，通常含有：取指周期（FE）、间址周期（IND）、执行周期（EX）、中断周期（INT）
3. 时钟周期（节拍）：每一个机器周期都包含若干的时钟周期

### 数据流

1. 取指周期
   1. PC—>MAR—>地址总线—>主存
   2. CU控制信号—>控制总线—>主存
   3. 主存—>数据总线—>MDR—>IR
   4. CU发出读命令—>PC++
2. 间址周期
   1. Ad(IR)（或者MDR）—>MAR—>地址总线—>主存
   2. CU控制信号—>控制总线—>主存
   3. 主存数据—>地址总线—>MDR
3. 执行周期：各不相同
4. 中断周期（有中断请求是进入）
   1. CU控制SP--，SP—>MAR—>地址总线—>主存
   2. 控制信号—>控制总线—>主存
   3. PC—>MDR—>数据总线—>主存
   4. 将中断服务程序入口地址存放到PC

### 指令执行方案

1. 单指令周期
2. 多指令周期
3. 流水线指令周期

## 数据通路基本功能和结构

### 功能

在功能部件之间传送数据

### 基本结构

1. CPU内部单总线
2. CPU内部三总线
3. 专用数据通路

### 数据传递

1. 寄存器之间
2. 主存和CPU之间
3. 执行算数或者逻辑运算

## 控制器功能和工作原理

### 结构

硬布线控制器

#### 微程序控制器

执行步骤：

1. PC—>MAR，1—>R
2. Ad(CMDR)—>CMAR：形成微地址
3. M(MAR)—>MDR，(PC)+1—>PC
4. Ad(CMDR)—>CMAR
5. MDR—>IR
6. OP(IR)—>微地址形成部件—>CMAR

1. 基本术语
   1. 微命令与微操作
   2. 微指令与微周期：微指令包含若干个微命令，一条微指令一般由操作控制字段和顺序控制字段组成
      1. 操作控制字段：控制产生操作所需要的各种控制信号
      2. 顺序控制字段：用于产生下一条微指令所需要的微地址
   3. 控制存储器（CM）：存放微程序
   4. 微地址寄存器：存放微指令地址
   5. 微指令寄存器：存放微指令
2. 工作过程
   1. 首先自动将取指微程序入口地址送往CMAR，并从CM之中取出相应的指令送往CMDR，执行结束之后机器指令入IR
   2. 机器指令操作码通过微地址形成部件产生微程序的入口地址送往CMAR
   3. CM之中逐条取出微指令并执行
   4. 执行完一条机器指令的微指令之后又回到取指微程序入口地址，周而复始

**微指令编码方式**

1. 直接编码：简单，快捷，并行性好
2. 字段直接编码：互斥的微指令存放在一起，相融的微指令存放在一起，这样的话一个组还要流出一个空闲的形式用来表示不发生任何操作
3. 字段间编码

**微地址形成方式**

1. 直接由微指令下地址字段给出
2. 根据机器指令操作码形成

**微指令分类**

1. 水平型微指令：直接编码、字段间编码、字段直接编码。优点是微程序短，速度快；缺点是指令长，编写程序复杂
2. 垂直型微指令：类似于编写机器指令。有点事指令格式短，编写简单；但缺点是微程序复杂较长
3. 混合型微指令：垂直型基础上加上一些不太复杂的并行操作

## 指令流水线

### 流水线的方式

1. 顺序执行方式
2. 一次重叠执行方式
3. 二次重叠执行方式
4. 一条指令如果可以分为n个步骤，那么最多可以有n-1次重叠

### 流水线表示方法

时空图

### 流水线特点

1. 将一个任务分为若干个小的有联系的子任务
2. 流水线的每一个功能部件后面都要有一个缓冲寄存器用来保存本流水段执行的结果
3. 各个功能段的时间应该尽可能的相等
4. 装入时间：第一个任务进入到流水线到输出的时间；排空时间：最后一个任务进入流水线到输出的时间

### 流水线的分类

1. 部件功能级、处理机级、处理机间级
   1. 将复杂的运算组成流水线的工作方式
   2. 取指、译码、执行等
   3. 每个处理机专门完成一个特定的任务，将结果保存到与下一个处理机共享的存储器之中
2. 功能：
   1. 单功能
   2. 多功能
3. 动态静态
   1. 静态：同一时间内，流水线的各个段只可以按照一种功能的连接方式
   2. 动态：某些段在运算时，其他段可以进行其他的运算
4. 线性非线性
   1. 线性：无反馈回路
   2. 非线性：存在反馈回路

### 流水线影响的因素

1. 冲突：多条指令争抢使用同一个资源

   1. 解决方法：后一条指令后移暂停若干个周期或者单独设置数据和指令存储器

2. 相关

   1. 数据相关：下一条指令会用到这一条指令计算的结果

      解决方法：

      1. 硬件阻塞或者NOP
      2. 数据旁路：直接传递数据
      3. 编译优化

   2. 控制相关：指令可能会进行转移

      解决方法：

      1. 分支预测
      2. 两个方向都预取
      3. 加快提前形成条件码
      4. 提高转移的准确率

### 流水线的性能指标

1. 吞吐率：任务数/时间长度
2. 加速比：
3. 效率：面积占比

### 超标量流水线

1. 超标量流水线：每个周期内可以并发执行多条指令
2. 超流水线技术：时钟周期内再分段
3. 超长指令字